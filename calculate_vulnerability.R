#Add demographic dependence types and vulnerability categories

args = commandArgs(trailingOnly = TRUE)

library(dplyr)
library(sf)

city <- args[1]

dir.create("./results/")
dir.create(paste0("./results/", city))
filename <- paste0('./results/', city, '/accessibility_results.gpkg')

acc_results <- st_read(filename)

#Demographic dependence types
acc_results$dep_old <- acc_results$res_65_/acc_results$res_15_64
acc_results$dep_young <- acc_results$res_0_14/acc_results$res_15_64
acc_results$dep_type <- "OT"
acc_results$dep_type[acc_results$res == 0] <- NA
acc_results$dep_type[acc_results$dep_old > median(acc_results$dep_old, na.rm = TRUE)] <- "HO" #High old age dependency
acc_results$dep_type[acc_results$dep_young > median(acc_results$dep_young, na.rm = TRUE)] <- "HY" #High young age dependency
acc_results$dep_type[acc_results$dep_old > median(acc_results$dep_old, na.rm = TRUE) & acc_results$dep_young > median(acc_results$dep_young, na.rm = TRUE)] <- "HD" #High both

#Vulnerability classes
acc_results$vulnerability <- NA
acc_results$vulnerability[acc_results$res > 0 ] <- "Low"
acc_results$vulnerability[(acc_results$dep_old > median(acc_results$dep_old, na.rm = TRUE) &
                              acc_results$dep_old < quantile(acc_results$dep_old, probs = 0.75, na.rm = TRUE)) | 
                             (acc_results$dep_young > median(acc_results$dep_young, na.rm = TRUE) &
                                acc_results$dep_young < quantile(acc_results$dep_young, probs = 0.75, na.rm = TRUE)) &
                             acc_results$income_class == "L"] <- "Moderate"
acc_results$vulnerability[(acc_results$dep_old >= quantile(acc_results$dep_old, probs = 0.75, na.rm = TRUE) | 
                              acc_results$dep_young >= quantile(acc_results$dep_young, probs = 0.75, na.rm = TRUE)) &
                             acc_results$income_class == "L"] <- "High"
acc_results$vulnerability <- factor(acc_results$vulnerability, levels = c("High", "Moderate", "Low"))

st_write(acc_results, dsn = paste0("./results/", city, "/accessibility_results.gpkg"), append = FALSE)